<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Birth Insights – Demo</title>
  <style>
    :root { --bg:#0b1020; --panel:#141a33; --ink:#e7ecff; --muted:#9fb2ff33; --accent:#7aa2ff; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1530);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:auto;padding:24px}
    h1{font-size:1.75rem;margin:0 0 6px}
    h2{font-size:1.1rem;margin:0 0 8px;color:#d5deff}
    p.sub{margin:0 0 18px;color:#c6d3ffcc}
    .card{background:radial-gradient(1200px 600px at -15% -15%,#22316633 0%,#080c1d00 50%),var(--panel);border:1px solid #233057;border-radius:16px;box-shadow:0 10px 30px #0006}
    .pad{padding:18px}
    .grid{display:grid;gap:16px}
    .inputs{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{display:block;font-weight:600;margin:0 0 6px}
    input,select,button,textarea{width:100%;box-sizing:border-box;font:inherit}
    input,select,textarea{padding:10px 12px;background:#0f1530;border:1px solid #2b3a66;color:var(--ink);border-radius:12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#6e97ff;box-shadow:0 0 0 3px #6e97ff33}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{cursor:pointer;background:linear-gradient(180deg,#7aa2ff,#628cff);color:#08122e;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn.secondary{background:#0f1530;color:#cfe0ff;border:1px solid #2b3a66}
    .muted{color:#c6d3ff99;font-size:.95rem}
    .chart{height:360px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.9rem;white-space:pre-wrap;background:#0f1530;padding:10px;border-radius:10px;border:1px solid #2b3a66;color:#d7e2ff}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#243461;border:1px solid #2b3a66;color:#cfe0ff;font-size:.85rem}
    .ok{color:#8ff2c6}
    .err{color:#ff9e9e}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.35.2"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Birth Insights <span class="badge">single-file demo</span></h1>
    <p class="sub">Enter your name and (optionally) your birth state and year. The page will call your <strong>Python</strong> functions in the browser (via Pyodide) and then render visualizations.</p>

    <div class="card pad" id="formCard">
      <div class="grid inputs">
        <div>
          <label for="name">Name (required)</label>
          <input id="name" type="text" placeholder="Ada" required />
        </div>
        <div>
          <label for="state">Birth state (optional)</label>
          <input id="state" type="text" placeholder="Nebraska" />
        </div>
        <div>
          <label for="year">Birth year (optional)</label>
          <input id="year" type="number" min="1900" max="2100" placeholder="1992" />
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button class="btn" id="runBtn">Run analysis</button>
        <button class="btn secondary" id="resetBtn" type="button">Reset</button>
        <span class="muted" id="status">Python runtime: loading…</span>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <!-- Summary section -->
      <div class="card pad">
        <h2>Summary</h2>
        <div id="summary" class="mono">(Your summary will appear here.)</div>
      </div>

      <!-- Visuals section -->
      <div class="card pad">
        <h2>Visuals</h2>
        <div id="charts"></div>
      </div>

      <div class="card pad">
        <h2>Quick tests</h2>
        <div class="row">
          <button class="btn secondary" id="testJerome1993">Test: Jerome, 1993</button>
          <button class="btn secondary" id="testAdaNone">Test: Ada, (no year)</button>
          <button class="btn secondary" id="testLowerJerome1993">Test: jerome (lower), 1993</button>
        </div>
        <p class="muted" style="margin-top:8px">These call the same <span class="mono">compute_visuals</span> function and help confirm the dataset loaded and matching works.</p>
      </div>

      <div class="card pad">
        <h2>How to plug in your Python</h2>
        <ol class="muted">
          <li>Find the section in the code below labeled <strong>PASTE YOUR PYTHON FUNCTIONS HERE</strong>.</li>
          <li>Paste your functions there. Make sure to expose a single function named <span class="mono">compute_visuals(name, state=None, year=None)</span> that returns a JSON-serializable dict like:
            <div class="mono">{
  "summary": "short string",
  "charts": [
    {"title": "My Chart", "x": [1,2,3], "y":[2,3,1], "x_label":"Month", "y_label":"Value"}
  ]
}</div>
          </li>
          <li>Click <strong>Run analysis</strong>.</li>
        </ol>
      </div>

      <div class="card pad">
        <h2>Embedded code (for quick edits)</h2>
        <details>
          <summary>Show Python stub & JS runner (now with diagnostics + tests)</summary>
          <pre class="mono" id="codeView"></pre>
        </details>
      </div>
    </div>
  </div>

<script>
  const PY_CODE = `
# ===================== PASTE YOUR PYTHON FUNCTIONS HERE =====================
# Minimal example that fetches your CSV from GitHub, matches on name & year,
# and returns a simple English sentence + an optional bar chart.
# Works entirely in the browser via Pyodide (no server needed).

from pyodide.http import open_url
import io, csv, json, sys

# Prefer the canonical raw URL and fall back to the originally provided one
URL_CANDIDATES = [
    "https://raw.githubusercontent.com/jeromeroehmdoane/names/main/small_demo.csv",  # canonical
    "https://raw.githubusercontent.com/jeromeroehmdoane/names/refs/heads/main/small_demo.csv"  # provided
]

def _read_name_data(url: str):
    """Read CSV from URL and yield normalized rows {name:str, year:int, count:int}.
    Returns (rows, meta) where meta has: url, rows_parsed, header, sample_rows.
    """
    text = open_url(url).read()
    rdr = csv.DictReader(io.StringIO(text))
    rows = [row for row in rdr]

    # Helper: get with fallbacks
    def g(r, *keys, default=""):
        for k in keys:
            if k in r and r[k] is not None:
                return r[k]
        return default

    norm = []
    for r in rows:
        name = g(r, 'name','Name').strip()
        yraw = g(r, 'year','Year').strip()
        craw = g(r, 'frequency','Frequency','freq','Freq','count','Count','n','N','Number','births','Births','value','Value').strip()
        if not name:
            continue
        try:
            year = int(float(yraw)) if yraw else None
        except Exception:
            year = None
        try:
            count = int(float(craw)) if craw else 0
        except Exception:
            count = 0
        if year is None:
            continue
        norm.append({'name': name, 'year': year, 'count': count})

    meta = {
        'url': url,
        'rows_parsed': len(norm),
        'header': list(rows[0].keys()) if rows else [],
        'sample_rows': rows[:3]
    }
    return norm, meta


def compute_visuals(name, state=None, year=None):
    """
    Match user-provided name/year to counts from the CSV. If year omitted, report
    totals and peak. Also expose lightweight diagnostics so you can verify that
    the dataset loaded correctly from GitHub Raw.
    """
    q_name = (name or '').strip()
    if not q_name:
        return {"summary": "Please provide a name.", "charts": [], "debug": {"note": "missing name"}}

    # Normalize for case-insensitive matching
    q_lower = q_name.lower()
    try:
        q_year = int(year) if year is not None and str(year).strip() else None
    except Exception:
        q_year = None

    # Try candidate URLs until one parses nonzero rows
    last_meta = {}
    data = []
    for U in URL_CANDIDATES:
        try:
            data, meta = _read_name_data(U)
            last_meta = meta
            if len(data) > 0:
                break
        except Exception as e:
            last_meta = {"url": U, "error": str(e)}
            data = []

    # Build series for the given name
    series = {}
    for r in data:
        if r['name'].lower() == q_lower:
            series[r['year']] = series.get(r['year'], 0) + r['count']

    if not data:
        msg = ("Could not load any rows from the dataset. Check that the CSV is public "
               "and that the URL supports CORS. Tried URL: " + str(last_meta.get('url')))
        return {"summary": msg, "charts": [], "debug": last_meta}

    if not series:
        msg = f"I couldn't find the name '{q_name}' in the dataset."
        return {"summary": msg, "charts": [], "debug": last_meta}

    if q_year is not None:
        c = int(series.get(q_year, 0))
        msg = f"You were one of {c} {q_name}'s born in {q_year}."
        # Include ALL available years for this name in the dataset (no windowing)
        years_sorted = sorted(series.keys())
        x = years_sorted
        y = [int(series[y]) for y in x]
        charts = [{"title": f"Counts for {q_name} by year", "x": x, "y": y, "x_label": "Year", "y_label": "Count"}]
        return {"summary": msg, "charts": charts, "debug": last_meta}
    else:
        total = int(sum(series.values()))
        peak_year = max(series, key=lambda y: series[y])
        peak_count = int(series[peak_year])
        msg = (f"We found {total} occurrences of the name {q_name} across all years. "
               f"Peak popularity in {peak_year} with {peak_count} births.")
        years_sorted = sorted(series.keys())
        x = years_sorted
        y = [int(series[y]) for y in x]
        charts = [{"title": f"Counts for {q_name} by year", "x": x, "y": y, "x_label": "Year", "y_label": "Count"}]
        return {"summary": msg, "charts": charts, "debug": last_meta}
# ===================== END USER PYTHON SECTION ==============================
`;

  const status = document.getElementById('status');
  const codeView = document.getElementById('codeView');
  codeView.textContent = PY_CODE;

  let pyodide = null;
  let pyReady = (async () => {
    try {
      pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.4/full/' });
      status.innerHTML = 'Python runtime: <span class="ok">ready</span>';
      return true;
    } catch (err) {
      status.innerHTML = 'Python runtime: <span class="err">failed to load</span>';
      console.error(err);
      return false;
    }
  })();

  const elName = document.getElementById('name');
  const elState = document.getElementById('state');
  const elYear = document.getElementById('year');
  const runBtn = document.getElementById('runBtn');
  const resetBtn = document.getElementById('resetBtn');
  const chartsDiv = document.getElementById('charts');
  const summaryDiv = document.getElementById('summary');

  function clearOutputs(){
    chartsDiv.innerHTML = '';
    summaryDiv.textContent = '(Your summary will appear here.)';
  }

  resetBtn.addEventListener('click', () => {
    elName.value = '';
    elState.value = '';
    elYear.value = '';
    clearOutputs();
  });

  // Quick tests
  const btnTest1 = document.getElementById('testJerome1993');
  const btnTest2 = document.getElementById('testAdaNone');
  function runQuickTest(nm, yr){
    elName.value = nm; elYear.value = yr ?? ''; elState.value = '';
    runBtn.click();
  }
  if (btnTest1) btnTest1.addEventListener('click', () => runQuickTest('Jerome', '1993'));
  if (btnTest2) btnTest2.addEventListener('click', () => runQuickTest('Ada', ''));

  runBtn.addEventListener('click', async () => {
    clearOutputs();
    if(!elName.value.trim()){
      alert('Please enter a name.');
      elName.focus();
      return;
    }
    runBtn.disabled = true;
    runBtn.textContent = 'Running…';

    try{
      const ok = await pyReady;
      if(!ok) throw new Error('Pyodide not ready');

      await pyodide.runPythonAsync(PY_CODE);

      pyodide.globals.set('name_js', elName.value);
      pyodide.globals.set('state_js', elState.value);
      pyodide.globals.set('year_js', elYear.value);

      const outJson = await pyodide.runPythonAsync(`
import json
name = (name_js or '').strip()
state = (state_js or '').strip() or None
try:
    year = int(year_js) if str(year_js).strip() else None
except Exception:
    year = None
res = compute_visuals(name=name, state=state, year=year)
json.dumps(res)
`);

      const result = JSON.parse(outJson);
      renderSummary(result.summary);
      // Show lightweight diagnostics if available
      if (result.debug) {
        const diag = document.createElement('div');
        diag.className = 'muted';
        diag.style.marginTop = '8px';
        diag.textContent = `Data source: ${result.debug.url || 'unknown'} | rows parsed: ${result.debug.rows_parsed || 0}`;
        summaryDiv.appendChild(diag);
      }
      renderCharts(result.charts || []);

    }catch(err){
      console.error(err);
      summaryDiv.innerHTML = `<span class="err">Error:</span> ${String(err)}`;
    }finally{
      runBtn.disabled = false;
      runBtn.textContent = 'Run analysis';
    }
  });

  // Rendering
  function renderSummary(text){
    summaryDiv.textContent = text || '(No summary returned)';
  }

  function renderCharts(charts){
    const chartsRoot = document.getElementById('charts');
    chartsRoot.innerHTML = '';
    if(!Array.isArray(charts) || charts.length === 0){
      const stub = document.createElement('div');
      stub.className = 'muted';
      stub.textContent = 'No charts returned. Your function should return a list under "charts".';
      chartsRoot.appendChild(stub);
      return;
    }
    charts.forEach((c, i) => {
      const id = `plot_${i}`;
      const holder = document.createElement('div');
      holder.className = 'chart';
      holder.id = id;
      chartsRoot.appendChild(holder);

      const trace = { type: 'scatter', mode: 'lines+markers', x: c.x || [], y: c.y || [] };
      const layout = {
        title: c.title || `Chart ${i+1}`,
        margin: {l:48, r:20, t:48, b:48},
        xaxis: { title: c.x_label || 'x' },
        yaxis: { title: c.y_label || 'y' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: '#e7ecff'}
      };
      Plotly.newPlot(id, [trace], layout, {displayModeBar: true, responsive: true});
    });
  }
</script>
</body>
</html>
