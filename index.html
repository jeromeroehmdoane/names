<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Birth Insights – Demo</title>
  <style>
    :root { --bg:#0b1020; --panel:#141a33; --ink:#e7ecff; --muted:#9fb2ff33; --accent:#7aa2ff; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1530);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:auto;padding:24px}
    h1{font-size:1.75rem;margin:0 0 6px}
    h2{font-size:1.1rem;margin:0 0 8px;color:#d5deff}
    p.sub{margin:0 0 18px;color:#c6d3ffcc}
    .card{background:radial-gradient(1200px 600px at -15% -15%,#22316633 0%,#080c1d00 50%),var(--panel);border:1px solid #233057;border-radius:16px;box-shadow:0 10px 30px #0006}
    .pad{padding:18px}
    .grid{display:grid;gap:16px}
    .inputs{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{display:block;font-weight:600;margin:0 0 6px}
    input,select,button,textarea{width:100%;box-sizing:border-box;font:inherit}
    input,select,textarea{padding:10px 12px;background:#0f1530;border:1px solid #2b3a66;color:var(--ink);border-radius:12px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#6e97ff;box-shadow:0 0 0 3px #6e97ff33}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{cursor:pointer;background:linear-gradient(180deg,#7aa2ff,#628cff);color:#08122e;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn.secondary{background:#0f1530;color:#cfe0ff;border:1px solid #2b3a66}
    .muted{color:#c6d3ff99;font-size:.95rem}
    .chart{height:360px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.9rem;white-space:pre-wrap;background:#0f1530;padding:10px;border-radius:10px;border:1px solid #2b3a66;color:#d7e2ff}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#243461;border:1px solid #2b3a66;color:#cfe0ff;font-size:.85rem}
    .ok{color:#8ff2c6}
    .err{color:#ff9e9e}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.35.2"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Birth Insights <span class="badge">single-file demo</span></h1>
    <p class="sub">Enter your name and (optionally) your birth state and year. The page will call your <strong>Python</strong> functions in the browser (via Pyodide) and then render visualizations.</p>

    <div class="card pad" id="formCard">
      <div class="grid inputs">
        <div>
          <label for="name">Name (required)</label>
          <input id="name" type="text" placeholder="Ada" required />
        </div>
        <div>
          <label for="state">Birth state (optional)</label>
          <input id="state" type="text" placeholder="Nebraska" />
        </div>
        <div>
          <label for="year">Birth year (optional)</label>
          <input id="year" type="number" min="1900" max="2100" placeholder="1992" />
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <button class="btn" id="runBtn">Run analysis</button>
        <button class="btn secondary" id="resetBtn" type="button">Reset</button>
        <span class="muted" id="status">Python runtime: loading…</span>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <!-- Summary section -->
      <div class="card pad">
        <h2>Summary</h2>
        <div id="summary" class="mono">(Your summary will appear here.)</div>
      </div>

      <!-- Visuals section -->
      <div class="card pad">
        <h2>Visuals</h2>
        <div id="charts"></div>
      </div>

      <div class="card pad">
        <h2>Quick tests</h2>
        <div class="row">
          <button class="btn secondary" id="testJerome1993">Test: Jerome, 1993</button>
          <button class="btn secondary" id="testAdaNone">Test: Ada, (no year)</button>
          <button class="btn secondary" id="testLowerJerome1993">Test: jerome (lower), 1993</button>
        </div>
        <p class="muted" style="margin-top:8px">These call the same <span class="mono">compute_visuals</span> function and help confirm the dataset loaded and matching works.</p>
      </div>

      <div class="card pad">
        <h2>How to plug in your Python</h2>
        <ol class="muted">
          <li>Find the section in the code below labeled <strong>PASTE YOUR PYTHON FUNCTIONS HERE</strong>.</li>
          <li>Paste your functions there. Make sure to expose a single function named <span class="mono">compute_visuals(name, state=None, year=None)</span> that returns a JSON-serializable dict like:
            <div class="mono">{
  "summary": "short string",
  "charts": [
    {"title": "My Chart", "x": [1,2,3], "y":[2,3,1], "x_label":"Month", "y_label":"Value"}
  ]
}</div>
          </li>
          <li>Click <strong>Run analysis</strong>.</li>
        </ol>
      </div>

      <div class="card pad">
        <h2>Embedded code (for quick edits)</h2>
        <details>
          <summary>Show Python stub & JS runner (now with diagnostics + tests)</summary>
          <pre class="mono" id="codeView"></pre>
        </details>
      </div>
    </div>
  </div>

<script>
  const PY_CODE = `
# ===================== PASTE YOUR PYTHON FUNCTIONS HERE =====================
from pyodide.http import open_url
import io, csv, json, sys

# Updated data source URL
URL_CANDIDATES = [
    "https://raw.githubusercontent.com/jeromeroehmdoane/names/refs/heads/main/small_demo.csv"
]

def _read_name_data(url: str):
    text = open_url(url).read()
    rdr = csv.DictReader(io.StringIO(text))
    rows = [row for row in rdr]

    def g(r, *keys, default=""):
        for k in keys:
            if k in r and r[k] is not None:
                return r[k]
        return default

    norm = []
    for r in rows:
        name = g(r, 'name','Name').strip()
        yraw = g(r, 'year','Year').strip()
        craw = g(r, 'frequency','Frequency','freq','Freq').strip()
        if not name:
            continue
        try:
            year = int(float(yraw)) if yraw else None
        except Exception:
            year = None
        try:
            count = int(float(craw)) if craw else 0
        except Exception:
            count = 0
        if year is None:
            continue
        norm.append({'name': name, 'year': year, 'count': count})

    meta = {
        'url': url,
        'rows_parsed': len(norm),
        'header': list(rows[0].keys()) if rows else [],
        'sample_rows': rows[:3]
    }
    return norm, meta


def compute_visuals(name, state=None, year=None):
    q_name = (name or '').strip()
    if not q_name:
        return {"summary": "Please provide a name.", "charts": [], "debug": {"note": "missing name"}}

    q_lower = q_name.lower()
    try:
        q_year = int(year) if year is not None and str(year).strip() else None
    except Exception:
        q_year = None

    last_meta = {}
    data = []
    for U in URL_CANDIDATES:
        try:
            data, meta = _read_name_data(U)
            last_meta = meta
            if len(data) > 0:
                break
        except Exception as e:
            last_meta = {"url": U, "error": str(e)}
            data = []

    series = {}
    for r in data:
        if r['name'].lower() == q_lower:
            series[r['year']] = series.get(r['year'], 0) + r['count']

    if not data:
        msg = ("Could not load any rows from the dataset. Check that the CSV is public "
               "and that the URL supports CORS. Tried URL: " + str(last_meta.get('url')))
        return {"summary": msg, "charts": [], "debug": last_meta}

    if not series:
        msg = f"I couldn't find the name '{q_name}' in the dataset."
        return {"summary": msg, "charts": [], "debug": last_meta}

    if q_year is not None:
        c = int(series.get(q_year, 0))
        msg = f"You were one of {c} {q_name}'s born in {q_year}."
        years_sorted = sorted(series.keys())
        x = years_sorted
        y = [int(series[y]) for y in x]
        charts = [{"title": f"Counts for {q_name} by year", "x": x, "y": y, "x_label": "Year", "y_label": "Count"}]
        return {"summary": msg, "charts": charts, "debug": last_meta}
    else:
        total = int(sum(series.values()))
        peak_year = max(series, key=lambda y: series[y])
        peak_count = int(series[peak_year])
        msg = (f"We found {total} occurrences of the name {q_name} across all years. "
               f"Peak popularity in {peak_year} with {peak_count} births.")
        years_sorted = sorted(series.keys())
        x = years_sorted
        y = [int(series[y]) for y in x]
        charts = [{"title": f"Counts for {q_name} by year", "x": x, "y": y, "x_label": "Year", "y_label": "Count"}]
        return {"summary": msg, "charts": charts, "debug": last_meta}
# ===================== END USER PYTHON SECTION ==============================
`;
</script>
</body>
</html>
